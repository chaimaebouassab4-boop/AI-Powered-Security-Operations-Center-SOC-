<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SOC IA Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b1220; color:#e5e7eb; }
    .glass { background: rgba(15,23,42,.75); border:1px solid rgba(255,255,255,.08); border-radius:18px; }
    .kpi { font-size:34px; font-weight:800; }
    .muted { color: rgba(229,231,235,.75); font-size: 12px; }
    .badge-soft { border:1px solid rgba(255,255,255,.10); background: rgba(15,23,42,.6); }
    .dot { width:8px;height:8px;border-radius:999px;background:#22c55e; display:inline-block; }
    .table { color:#e5e7eb; }
    .table td, .table th { border-color: rgba(255,255,255,.08); }
  </style>
</head>
<body class="p-4">

  <div class="glass p-4 mb-4 d-flex justify-content-between align-items-center">
    <div>
      <h2 class="m-0 fw-bold">SOC IA Dashboard</h2>
      <div class="muted">Security Operations Center — IA • Kafka</div>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <span class="badge badge-soft px-3 py-2"><span class="dot me-2"></span>Connecté</span>
      <span class="badge badge-soft px-3 py-2">Opérationnel</span>
      <span id="now" class="badge badge-soft px-3 py-2">--</span>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-3"><div class="glass p-3">
      <div class="muted">Événements</div><div id="k_events" class="kpi">0</div>
    </div></div>
    <div class="col-md-3"><div class="glass p-3">
      <div class="muted">Alertes</div><div id="k_alerts" class="kpi">0</div>
    </div></div>
    <div class="col-md-2"><div class="glass p-3">
      <div class="muted">HIGH</div><div id="k_high" class="kpi">0</div>
    </div></div>
    <div class="col-md-2"><div class="glass p-3">
      <div class="muted">MEDIUM</div><div id="k_medium" class="kpi">0</div>
    </div></div>
    <div class="col-md-2"><div class="glass p-3">
      <div class="muted">LOW</div><div id="k_low" class="kpi">0</div>
    </div></div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="glass p-3 mb-3">
        <h5 class="fw-bold">Événements récents</h5>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Time</th><th>ID</th><th>Stage</th><th>Message</th></tr></thead>
            <tbody id="events_t"></tbody>
          </table>
        </div>
      </div>

      <div class="glass p-3">
        <h5 class="fw-bold">Alertes récentes</h5>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Time</th><th>ID</th><th>Severity</th><th>MITRE</th><th>Source</th></tr></thead>
            <tbody id="alerts_t"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="glass p-3">
        <h5 class="fw-bold">MITRE Top</h5>
        <div id="mitre_list" class="d-grid gap-2"></div>
      </div>
    </div>
  </div>

<script>
async function refresh(){
  const r = await fetch("/api/state");
  const s = await r.json();

  document.getElementById("now").textContent = s.now;
  document.getElementById("k_events").textContent = s.kpi.events;
  document.getElementById("k_alerts").textContent = s.kpi.alerts;
  document.getElementById("k_high").textContent = s.kpi.high;
  document.getElementById("k_medium").textContent = s.kpi.medium;
  document.getElementById("k_low").textContent = s.kpi.low;

  const et = document.getElementById("events_t");
  et.innerHTML = "";
  (s.events_recent || []).slice().reverse().forEach(e=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${e.timestamp||""}</td><td>${e.event_id||""}</td><td>${e.stage||""}</td><td style="max-width:520px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.message||""}</td>`;
    et.appendChild(tr);
  });

  const at = document.getElementById("alerts_t");
  at.innerHTML = "";
  (s.alerts_recent || []).slice().reverse().forEach(a=>{
    const mitre = a.technique_id || "";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${a.timestamp||""}</td><td>${a.alert_id||""}</td><td>${a.severity||""}</td><td>${mitre}</td><td>${a.source_ip||""}</td>`;
    at.appendChild(tr);
  });

  const ml = document.getElementById("mitre_list");
  ml.innerHTML = "";
  (s.mitre_top || []).forEach(x=>{
    const div = document.createElement("div");
    div.className = "badge badge-soft px-3 py-2 text-start";
    div.textContent = `${x.technique_id} — ${x.count}`;
    ml.appendChild(div);
  });
}
refresh();
setInterval(refresh, 2000);
</script>
</body>
</html>
